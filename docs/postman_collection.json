{
	"info": {
		"_postman_id": "agro-monitoring-api",
		"name": "Agro Monitoring API",
		"description": "API para monitoramento de áreas agrícolas com controle de pragas.\n\n**Importante:** Todas as rotas /v1/* requerem autenticação. Execute 'Login and Get Token' primeiro.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8080",
			"type": "string"
		},
		{
			"key": "keycloak_url",
			"value": "http://localhost:9090",
			"type": "string"
		},
		{
			"key": "keycloak_realm",
			"value": "agro-realm",
			"type": "string"
		},
		{
			"key": "access_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "monitoramento_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "area_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "job_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "client_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "client_slug",
			"value": "",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "Authentication (Keycloak)",
			"item": [
				{
					"name": "Login and Get Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.access_token) {",
									"    pm.collectionVariables.set('access_token', jsonData.access_token);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/x-www-form-urlencoded"
							}
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "client_id",
									"value": "agro-api",
									"type": "text"
								},
								{
									"key": "username",
									"value": "testuser",
									"type": "text"
								},
								{
									"key": "password",
									"value": "password",
									"type": "text"
								},
								{
									"key": "grant_type",
									"value": "password",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{keycloak_url}}/realms/{{keycloak_realm}}/protocol/openid-connect/token",
							"host": [
								"{{keycloak_url}}"
							],
							"path": [
								"realms",
								"{{keycloak_realm}}",
								"protocol",
								"openid-connect",
								"token"
							]
						},
						"description": "Faça login com um usuário do Keycloak para obter um token de acesso.\n\nEste request usa os valores padrão `testuser`/`password`. Após a execução, o `access_token` será salvo automaticamente como uma variável da coleção para ser usado nos endpoints protegidos."
					},
					"response": []
				}
			]
		},
		{
			"name": "Health",
			"item": [
				{
					"name": "Health Check",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/health",
							"host": ["{{base_url}}"],
							"path": ["health"]
						},
						"description": "Verifica se a API está funcionando. Esta rota é pública e não requer autenticação."
					},
					"response": []
				}
			]
		},
		{
			"name": "Users",
			"item": [
				{
					"name": "Get Current User (/me)",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/users/me",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"v1",
								"users",
								"me"
							]
						},
						"description": "Retorna as informações (claims) do usuário autenticado.\n\n**Requer autenticação.** Execute o request 'Login and Get Token' primeiro para obter e salvar o token de acesso."
					},
					"response": []
				}
			]
		},
		{
			"name": "Monitoramentos",
			"item": [
				{
					"name": "Upload CSV",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.id) {",
									"    pm.collectionVariables.set('monitoramento_id', jsonData.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [],
						"body": {
							"mode": "formdata",
							"formdata": [
								{
									"key": "file",
									"type": "file",
									"src": ""
								}
							]
						},
						"url": {
							"raw": "{{base_url}}/v1/monitoramentos",
							"host": ["{{base_url}}"],
							"path": ["v1", "monitoramentos"]
						},
						"description": "Upload de arquivo CSV com dados de monitoramento.\n\n**Requer autenticação.**\n\nO CSV deve ter separador `;` e conter as colunas:\n- Id, Setor, Setor2, Cod.Fazenda, Desc.Fazenda, Quadra, Corte, Área Total, Desc. Textura Solo, Corte Atual, Reforma, Mês Colheita, Restrição\n- Colunas após Restrição são interpretadas como pragas (S/N)"
					},
					"response": []
				},
				{
					"name": "Listar Monitoramentos",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/monitoramentos?page=1&page_size=10",
							"host": ["{{base_url}}"],
							"path": ["v1", "monitoramentos"],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "10"
								}
							]
						},
						"description": "Lista todos os uploads de CSV com paginação.\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Buscar Monitoramento por ID",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/monitoramentos/{{monitoramento_id}}",
							"host": ["{{base_url}}"],
							"path": ["v1", "monitoramentos", "{{monitoramento_id}}"]
						},
						"description": "Retorna detalhes de um monitoramento específico.\n\n**Requer autenticação.**"
					},
					"response": []
				}
			]
		},
		{
			"name": "Áreas",
			"item": [
				{
					"name": "Listar Áreas por Monitoramento",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.data && jsonData.data.length > 0) {",
									"    pm.collectionVariables.set('area_id', jsonData.data[0].id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/areas?monitoramento_id={{monitoramento_id}}&page=1&page_size=10",
							"host": ["{{base_url}}"],
							"path": ["v1", "areas"],
							"query": [
								{
									"key": "monitoramento_id",
									"value": "{{monitoramento_id}}"
								},
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "10"
								}
							]
						},
						"description": "Lista todas as áreas de um monitoramento específico.\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Buscar Área por ID",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/areas/{{area_id}}",
							"host": ["{{base_url}}"],
							"path": ["v1", "areas", "{{area_id}}"]
						},
						"description": "Retorna detalhes de uma área específica.\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Buscar por Fazenda",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/areas/search/fazenda?cod=FAZ001&page=1&page_size=10",
							"host": ["{{base_url}}"],
							"path": ["v1", "areas", "search", "fazenda"],
							"query": [
								{
									"key": "cod",
									"value": "FAZ001"
								},
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "10"
								}
							]
						},
						"description": "Busca áreas por código de fazenda (busca parcial).\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Buscar por Praga",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/areas/search/praga?nome=Camalote&page=1&page_size=10",
							"host": ["{{base_url}}"],
							"path": ["v1", "areas", "search", "praga"],
							"query": [
								{
									"key": "nome",
									"value": "Camalote"
								},
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "10"
								}
							]
						},
						"description": "Busca áreas que possuem uma praga específica.\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Adicionar/Atualizar Aplicação de Herbicida",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"praga\": \"Camalote\",\n    \"posicao\": 1,\n    \"herbicida\": \"Boral\",\n    \"dose\": 1.40\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/areas/{{area_id}}/aplicacao",
							"host": ["{{base_url}}"],
							"path": ["v1", "areas", "{{area_id}}", "aplicacao"]
						},
						"description": "Adiciona ou atualiza uma aplicação de herbicida numa posição específica.\n\n**Requer autenticação.**\n\nCampos:\n- praga: nome da praga (deve existir na área)\n- posicao: número da aplicação (1, 2, 3, ...)\n- herbicida: nome do herbicida\n- dose: dosagem aplicada\n\nSe já existir aplicação na posição, será substituída (upsert)."
					},
					"response": []
				}
			]
		},
		{
			"name": "Clients",
			"item": [
				{
					"name": "Register User (Public)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"email\": \"joao@usinasantaclara.com\",\n    \"password\": \"senha123\",\n    \"first_name\": \"João\",\n    \"last_name\": \"Silva\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/register/{{client_slug}}",
							"host": ["{{base_url}}"],
							"path": ["v1", "register", "{{client_slug}}"]
						},
						"description": "Registra um novo usuário para um client específico.\n\n**Rota pública** (não requer autenticação).\n\nUse o slug do client na URL (ex: /v1/register/usina-santa-clara).\n\nO usuário será criado no Keycloak e associado ao client automaticamente."
					},
					"response": []
				},
				{
					"name": "Get My Client",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/clients/me",
							"host": ["{{base_url}}"],
							"path": ["v1", "clients", "me"]
						},
						"description": "Retorna informações do client do usuário autenticado.\n\n**Requer autenticação.**"
					},
					"response": []
				},
				{
					"name": "Get My Client Stats",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/clients/me/stats",
							"host": ["{{base_url}}"],
							"path": ["v1", "clients", "me", "stats"]
						},
						"description": "Retorna estatísticas do client do usuário autenticado.\n\n**Requer autenticação.**\n\nInclui:\n- Usuários atuais\n- Vagas disponíveis\n- Total de monitoramentos\n- Total de áreas"
					},
					"response": []
				},
				{
					"name": "List My Client Users",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/clients/me/users?page=1&page_size=20",
							"host": ["{{base_url}}"],
							"path": ["v1", "clients", "me", "users"],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "20"
								}
							]
						},
						"description": "Lista todos os usuários do client do usuário autenticado.\n\n**Requer autenticação.**"
					},
					"response": []
				}
			]
		},
		{
			"name": "Admin - Clients",
			"item": [
				{
					"name": "Create Client",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.data && jsonData.data.id) {",
									"    pm.collectionVariables.set('client_id', jsonData.data.id);",
									"    pm.collectionVariables.set('client_slug', jsonData.data.slug);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"name\": \"Usina Santa Clara\",\n    \"slug\": \"usina-santa-clara\",\n    \"max_users\": 15,\n    \"metadata\": {\n        \"cidade\": \"Ribeirão Preto\",\n        \"contato\": \"+55 16 99999-9999\"\n    }\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/admin/clients",
							"host": ["{{base_url}}"],
							"path": ["v1", "admin", "clients"]
						},
						"description": "Cria um novo client (usina).\n\n**Requer autenticação e permissão de admin.**\n\nCampos:\n- name: Nome da usina\n- slug: URL única (apenas lowercase, números e hífen)\n- max_users: Limite de usuários\n- metadata: Dados extras (opcional)\n\nCria automaticamente um grupo no Keycloak."
					},
					"response": []
				},
				{
					"name": "List Clients",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/admin/clients?page=1&page_size=20",
							"host": ["{{base_url}}"],
							"path": ["v1", "admin", "clients"],
							"query": [
								{
									"key": "page",
									"value": "1"
								},
								{
									"key": "page_size",
									"value": "20"
								}
							]
						},
						"description": "Lista todos os clients com paginação.\n\n**Requer autenticação e permissão de admin.**"
					},
					"response": []
				},
				{
					"name": "Get Client by ID",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/admin/clients/{{client_id}}",
							"host": ["{{base_url}}"],
							"path": ["v1", "admin", "clients", "{{client_id}}"]
						},
						"description": "Busca um client por ID.\n\n**Requer autenticação e permissão de admin.**"
					},
					"response": []
				},
				{
					"name": "Get Client Stats",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/admin/clients/{{client_id}}/stats",
							"host": ["{{base_url}}"],
							"path": ["v1", "admin", "clients", "{{client_id}}", "stats"]
						},
						"description": "Retorna estatísticas completas de um client.\n\n**Requer autenticação e permissão de admin.**\n\nInclui:\n- Usuários atuais vs. limite\n- Vagas disponíveis\n- Total de monitoramentos\n- Total de áreas"
					},
					"response": []
				}
			]
		},
		{
			"name": "Jobs (Processamento em Massa)",
			"item": [
				{
					"name": "Criar Job - Bulk Aplicações",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.id) {",
									"    pm.collectionVariables.set('job_id', jsonData.id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"aplicacoes\": [\n        {\n            \"area_id\": \"{{area_id}}\",\n            \"praga\": \"Camalote\",\n            \"posicao\": 1,\n            \"herbicida\": \"Boral\",\n            \"dose\": 1.40\n        },\n        {\n            \"area_id\": \"{{area_id}}\",\n            \"praga\": \"Camalote\",\n            \"posicao\": 2,\n            \"herbicida\": \"Roundup\",\n            \"dose\": 2.00\n        },\n        {\n            \"area_id\": \"{{area_id}}\",\n            \"praga\": \"Vassoura\",\n            \"posicao\": 1,\n            \"herbicida\": \"Hexagon\",\n            \"dose\": 1.80\n        }\n    ]\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/jobs/aplicacoes",
							"host": ["{{base_url}}"],
							"path": ["v1", "jobs", "aplicacoes"]
						},
						"description": "Cria um job para processar aplicações de herbicida em massa.\n\n**Requer autenticação.**\n\nCampos de cada item:\n- area_id: ID da área\n- praga: nome da praga\n- posicao: número da aplicação (1, 2, 3, ...)\n- herbicida: nome do herbicida\n- dose: dosagem\n\nO job é processado em background pelo Worker.\nUse GET /v1/jobs/{id} para acompanhar o progresso.\n\nSe enviar mesma area_id + praga + posicao mais de uma vez, a última sobrescreve (upsert)."
					},
					"response": []
				},
				{
					"name": "Status do Job",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/v1/jobs/{{job_id}}",
							"host": ["{{base_url}}"],
							"path": ["v1", "jobs", "{{job_id}}"]
						},
						"description": "Retorna o status atual do job.\n\n**Requer autenticação.**\n\nStatus possíveis:\n- pending: aguardando processamento\n- processing: em processamento\n- completed: concluído com sucesso\n- failed: falhou"
					},
					"response": []
				}
			]
		}
	]
}
